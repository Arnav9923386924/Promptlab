# Advanced Code Review Test Suite - Edge Cases & Complex Scenarios
metadata:
  name: Code Review - Advanced
  tags: [code-review, security, edge-cases]

defaults:
  temperature: 0

cases:
  # === SECURITY - CRITICAL ===
  - id: sec-xss-reflected
    prompt: |
      Review this JavaScript code for security issues:
      ```javascript
      app.get('/search', (req, res) => {
        const query = req.query.q;
        res.send(`<h1>Results for: ${query}</h1>`);
      });
      ```
    assertions:
      - type: regex
        pattern: "(?i)(xss|cross.site|script|sanitize|escape|security)"

  - id: sec-path-traversal
    prompt: |
      Review this Python code:
      ```python
      def get_file(filename):
          return open(f"/uploads/{filename}", "rb").read()
      ```
    assertions:
      - type: regex
        pattern: '(?i)(path.traversal|directory|security|\.\.\/|sanitize)'

  - id: sec-command-injection
    prompt: |
      Review this code:
      ```python
      import os
      def run_command(user_input):
          os.system(f"echo {user_input}")
      ```
    assertions:
      - type: regex
        pattern: "(?i)(command.injection|injection|shell|security|subprocess)"

  - id: sec-insecure-deserialization
    prompt: |
      Review this Python code:
      ```python
      import pickle
      def load_user_data(data):
          return pickle.loads(data)
      ```
    assertions:
      - type: regex
        pattern: "(?i)(deserializ|pickle|security|untrusted|arbitrary)"

  - id: sec-weak-crypto
    prompt: |
      Review this code:
      ```python
      import hashlib
      def hash_password(password):
          return hashlib.md5(password.encode()).hexdigest()
      ```
    assertions:
      - type: regex
        pattern: "(?i)(md5|weak|hash|bcrypt|argon|security|password)"

  # === PERFORMANCE - SUBTLE ===
  - id: perf-regex-redos
    prompt: |
      Review this code for performance issues:
      ```python
      import re
      def validate_email(email):
          pattern = r'^([a-zA-Z0-9]+)+@[a-zA-Z0-9]+\.[a-zA-Z]+$'
          return re.match(pattern, email)
      ```
    assertions:
      - type: regex
        pattern: "(?i)(redos|catastrophic|backtrack|regex|performance|dos)"

  - id: perf-memory-leak
    prompt: |
      Review this JavaScript code:
      ```javascript
      const cache = {};
      function processRequest(id, data) {
          cache[id] = data;  // Never cleaned up
          return cache[id];
      }
      ```
    assertions:
      - type: regex
        pattern: "(?i)(memory|leak|cache|cleanup|unbounded|grow)"

  - id: perf-blocking-io
    prompt: |
      Review this async Python code:
      ```python
      async def fetch_data():
          with open('large_file.txt', 'r') as f:
              return f.read()
      ```
    assertions:
      - type: regex
        pattern: "(?i)(blocking|async|sync|io|aiofiles|performance)"

  # === LOGIC BUGS - TRICKY ===
  - id: bug-float-comparison
    prompt: |
      Review this code for bugs:
      ```python
      def is_equal(a, b):
          return a == b  # Where a and b are floats
      
      result = is_equal(0.1 + 0.2, 0.3)
      ```
    assertions:
      - type: regex
        pattern: "(?i)(float|precision|comparison|epsilon|approximate)"

  - id: bug-race-condition
    prompt: |
      Review this code:
      ```python
      balance = 100
      def withdraw(amount):
          global balance
          if balance >= amount:
              balance -= amount
              return True
          return False
      ```
    assertions:
      - type: regex
        pattern: "(?i)(race|concurrent|thread|lock|atomic|synchron)"

  - id: bug-timezone
    prompt: |
      Review this code:
      ```python
      from datetime import datetime
      def get_today():
          return datetime.now().date()
      ```
    assertions:
      - type: regex
        pattern: "(?i)(timezone|utc|tz|aware|naive|time)"

  # === CLEAN CODE (should pass) ===
  - id: clean-well-structured
    prompt: |
      Review this code:
      ```python
      from dataclasses import dataclass
      from typing import List
      
      @dataclass
      class User:
          id: int
          name: str
          email: str
      
      def get_active_users(users: List[User]) -> List[User]:
          """Return users with valid emails."""
          return [u for u in users if '@' in u.email]
      ```
    assertions:
      - type: regex
        pattern: "(?i)(good|clean|well|correct|no.issue|readable|typed)"
